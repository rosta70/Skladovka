<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Tabulky s ukládáním dat</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
        }
        
        .tabulky-container {
            position: relative;
            margin-top: 20px;
        }
        
        .zakazka-sekce {
            position: absolute;
            left: 0;
            top: 0;
            width: 15ch;
            z-index: 2;
        }
        
        .hlavni-sekce {
            margin-left: 15ch;
            position: relative;
            z-index: 1;
        }
        
        table {
            border-collapse: collapse;
            width: 100%;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            box-sizing: border-box;
            height: 30px; /* Výška buňky - zde můžete změnit */
        }
        
        .hlavni-tabulka th, .hlavni-tabulka td {
            width: 15ch;
            max-width: 15ch;
            overflow: hidden;
            font-size: 12px;
        }
        
        /* Specifické šířky sloupců */
        .misto-sloupec {
            width: 7ch !important; /* Širší sloupec pro místo */
            max-width: 7ch !important;
        }
        
        .kusy-sloupec {
            width: 10ch !important; /* Užší sloupec pro SV */
            max-width: 10ch !important;
        }
        
        .soucet-kusu {
            width: 15ch !important; /* Sloupec pro SV-celkem */
            max-width: 15ch !important;
        }
        
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        input {
            width: 100%;
            box-sizing: border-box;
            border: none;
            background: transparent;
            height: 24px; /* Výška vstupů - zde můžete změnit */
        }
        
        input:focus {
            outline: 2px solid #4CAF50;
        }
        
        input.readonly {
            background-color: #f2f2f2;
            color: #666;
        }
        
        /* Styl pro dvouřádkovou zakázku */
        .zakazka-textarea {
            width: 100%;
            height: 40px; /* Výška pro dva řádky */
            resize: none;
            overflow: hidden;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: inherit;
            line-height: 1.2;
            padding: 2px;
            box-sizing: border-box;
        }
        
        .zakazka-textarea:focus {
            outline: 2px solid #4CAF50;
        }
        
        /* Styl pro editovatelnou hlavičku */
        .zakazka-header {
            width: 100%;
            height: 40px;
            resize: none;
            overflow: hidden;
            border: none;
            background: #f2f2f2;
            font-family: inherit;
            font-size: inherit;
            font-weight: bold;
            line-height: 1.2;
            text-align: center;
            padding: 2px;
            box-sizing: border-box;
        }
        
        .zakazka-header:focus {
            outline: 2px solid #4CAF50;
        }
        
        /* Nastavení výšky buňky pro zakázku */
        .zakazka-tabulka td, .zakazka-tabulka th {
            height: 50px; /* Upravená výška pro dvouřádkovou buňku */
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 10px;
            margin-right: 10px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button.danger {
            background-color: #f44336;
        }
        
        button.danger:hover {
            background-color: #d32f2f;
        }
        
        .akce-bunka {
            width: auto !important;
            background-color: #f2f2f2;
        }
        
        .ovladaci-prvky {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .sekce-ovladani {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        
        /* Dialog pro vymazání */
        .dialog-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .dialog {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            max-width: 500px;
            width: 90%;
        }
        
        .dialog h3 {
            margin-top: 0;
        }
        
        .dialog-tlacitka {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        
        /* Skrytí před tiskem */
        @media print {
            .no-print {
                display: none !important;
            }
            
            @page {
                size: landscape;
            }
            
            body * {
                visibility: hidden;
            }
            
            .tabulky-container, .tabulky-container * {
                visibility: visible;
            }
            
            .tabulky-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            
            button, .akce-bunka, input[type="button"] {
                display: none !important;
            }
            
            table {
                width: 100%;
                border-collapse: collapse;
            }
            
            th, td {
                border: 1px solid black;
            }
        }
        
        /* Styl pro tlačítko "Přidat další řádek" */
        .tlacitko-radek {
            background-color: #f2f2f2;
            text-align: center;
        }
        
        .tlacitko-radek td {
            border: none;
            padding: 5px;
        }
        
        .pridat-radek-btn {
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .pridat-radek-btn:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <h2>Evidence zakázek</h2>
    
    <div class="sekce-ovladani no-print">
        <h3>Základní ovládání</h3>
        <div class="ovladaci-prvky">
            <button onclick="pridatZakazku()">Přidat zakázku</button>
            <button onclick="pridatHlavniRadek()">Přidat řádek dat</button>
            <button class="danger" onclick="zobrazitDialogVymazani()">Vymazat všechna data</button>
            <button onclick="tiskTabulky()">Tisknout tabulku</button>
        </div>
    </div>
    
    <div class="sekce-ovladani no-print">
        <h3>Správa dat</h3>
        <div class="ovladaci-prvky">
            <button onclick="ulozitJSON()">Uložit data do souboru</button>
            <input type="text" id="nazevSouboruInput" placeholder="Název souboru (volitelné)" style="max-width: 200px;">
            <button onclick="document.getElementById('importSoubor').click()">Načíst data ze souboru</button>
            <input type="file" id="importSoubor" style="display: none;" onchange="nacistZeSouboru(event)" accept=".json">
        </div>
    </div>
    
    <div id="dialogVymazani" class="dialog-container" style="display: none;">
        <div class="dialog">
            <h3>Potvrdit vymazání</h3>
            <p>Opravdu chcete vymazat všechna data? Tato akce je nevratná.</p>
            <div class="dialog-tlacitka">
                <button onclick="skrytDialogVymazani()">Zrušit</button>
                <button class="danger" onclick="vymazatVsechnaData()">Vymazat</button>
            </div>
        </div>
    </div>
    
    <div id="statusMessage" class="status-message" style="display: none;"></div>
    
    <div class="tabulky-container">
        <div class="zakazka-sekce">
            <table class="zakazka-tabulka">
                <thead>
                    <tr>
                        <th><textarea maxlength="15" rows="2" id="zakazka-nadpis" class="zakazka-header" oninput="ulozitDoLocalStorage()">ZAKÁZKA</textarea></th>
                    </tr>
                </thead>
                <tbody id="zakazka-tbody"></tbody>
            </table>
        </div>
        
        <div class="hlavni-sekce">
            <table class="hlavni-tabulka">
                <thead>
                    <tr>
                        <th>TAVBA</th>
                        <th>VÁHA</th>
                        <th class="kusy-sloupec">SV</th>
                        <th class="misto-sloupec">MÍSTO</th>
                        <th>SOUČET</th>
                        <th class="soucet-kusu">SV-celkem</th>
                        <th>POZNÁMKA</th>
                        <th class="akce-bunka">AKCE</th>
                    </tr>
                </thead>
                <tbody id="hlavni-tbody"></tbody>
            </table>
        </div>
    </div>
    
    <script>
        // Počítadla řádků
        let pocetZakazek = 0;
        let pocetHlavnichRadku = 0;
        
        // Konstanta pro název v localStorage
        const STORAGE_KEY = 'evidence_zakazek_data';
        
        // Proměnná pro sledování tiché aktualizace (bez zobrazení zprávy)
        let tichaAktualizace = false;
        
        // Funkce pro zobrazení dialogu pro vymazání
        function zobrazitDialogVymazani() {
            document.getElementById('dialogVymazani').style.display = 'flex';
        }
        
        // Funkce pro skrytí dialogu pro vymazání
        function skrytDialogVymazani() {
            document.getElementById('dialogVymazani').style.display = 'none';
        }
        
        // Funkce pro vymazání všech dat
        function vymazatVsechnaData() {
            localStorage.removeItem(STORAGE_KEY);
            document.getElementById('zakazka-tbody').innerHTML = '';
            document.getElementById('hlavni-tbody').innerHTML = '';
            document.getElementById('zakazka-nadpis').value = 'ZAKÁZKA';
            pocetZakazek = 0;
            pocetHlavnichRadku = 0;
            
            // Vytvoření výchozích řádků
            tichaAktualizace = true; // Nastavit tichou aktualizaci
            pridatZakazku();
            pridatHlavniRadek();
            tichaAktualizace = false; // Vypnout tichou aktualizaci
            
            skrytDialogVymazani();
            zobrazitStatus('Všechna data byla vymazána', 'success');
        }
        
        // Funkce pro přidání nové zakázky
        function pridatZakazku() {
            const tbody = document.getElementById('zakazka-tbody');
            const newRow = document.createElement('tr');
            newRow.id = 'zakazka-' + pocetZakazek;
            
            newRow.innerHTML = `
                <td><textarea maxlength="15" rows="2" placeholder="Zakázka" class="zakazka-textarea" oninput="ulozitDoLocalStorage()"></textarea></td>
            `;
            
            tbody.appendChild(newRow);
            pocetZakazek++;
            ulozitDoLocalStorage();
        }
        
        // Funkce pro přidání nového řádku v hlavní tabulce
        function pridatHlavniRadek() {
            const tbody = document.getElementById('hlavni-tbody');
            const newRow = document.createElement('tr');
            newRow.id = 'hlavni-' + pocetHlavnichRadku;
            
            newRow.innerHTML = `
                <td><input type="text" placeholder="Tavba" oninput="ulozitDoLocalStorage()"></td>
                <td><input type="number" placeholder="Váha" class="vaha" oninput="prepocet(); ulozitDoLocalStorage()"></td>
                <td class="kusy-sloupec"><input type="number" placeholder="Kusy" class="kusy" oninput="prepocet(); ulozitDoLocalStorage()"></td>
                <td class="misto-sloupec"><input type="text" placeholder="Místo" oninput="ulozitDoLocalStorage()"></td>
                <td><input type="text" class="soucet readonly" readonly></td>
                <td class="soucet-kusu"><input type="text" class="soucet-kusu-hodnota readonly" readonly></td>
                <td><input type="text" placeholder="Poznámka" oninput="ulozitDoLocalStorage()"></td>
                <td class="akce-bunka">
                    <button onclick="smazatHlavniRadek(${pocetHlavnichRadku})">Smazat</button>
                </td>
            `;
            
            tbody.appendChild(newRow);
            
            // Odstraníme stávající tlačítko, pokud existuje
            const existujiciTlacitkoRadek = document.getElementById('tlacitko-radek');
            if (existujiciTlacitkoRadek) {
                existujiciTlacitkoRadek.remove();
            }
            
            // Přidáme nový řádek s tlačítkem na konec tbody
            const tlacitkoRadek = document.createElement('tr');
            tlacitkoRadek.id = 'tlacitko-radek';
            tlacitkoRadek.className = 'tlacitko-radek';
            
            const pocetSloupcu = newRow.cells.length;
            
            tlacitkoRadek.innerHTML = `
                <td colspan="${pocetSloupcu}">
                    <button class="pridat-radek-btn" onclick="pridatHlavniRadek()">+ Přidat další řádek</button>
                </td>
            `;
            
            tbody.appendChild(tlacitkoRadek);
            
            pocetHlavnichRadku++;
            
            // Přepočet součtů
            prepocet();
            ulozitDoLocalStorage();
        }
        
        // Funkce pro smazání řádku v hlavní tabulce
        function smazatHlavniRadek(id) {
            const radek = document.getElementById('hlavni-' + id);
            radek.remove();
            prepocet();
            ulozitDoLocalStorage();
        }
        
        // Funkce pro přepočet součtů
        function prepocet() {
            const radky = document.querySelectorAll('#hlavni-tbody tr:not(#tlacitko-radek)');
            let kumulativniSoucet = 0;
            let celkemKusy = 0;
            
            radky.forEach((radek, index) => {
                const vahaInput = radek.querySelector('.vaha');
                const soucetInput = radek.querySelector('.soucet');
                const kusyInput = radek.querySelector('.kusy');
                const soucetKusuInput = radek.querySelector('.soucet-kusu-hodnota');
                
                if (vahaInput && soucetInput) {
                    const vahaHodnota = parseFloat(vahaInput.value) || 0;
                    kumulativniSoucet += vahaHodnota;
                    soucetInput.value = kumulativniSoucet.toFixed(2);
                }
                
                if (kusyInput && soucetKusuInput) {
                    const kusyHodnota = parseInt(kusyInput.value) || 0;
                    celkemKusy += kusyHodnota;
                    soucetKusuInput.value = celkemKusy;
                }
            });
        }
        
        // Funkce pro uložení dat do localStorage
        function ulozitDoLocalStorage() {
            const data = ziskatVsechnaData();
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            
            // Zobrazit zprávu o úspěšném uložení, pokud nejde o tichou aktualizaci
            if (!tichaAktualizace) {
                zobrazitStatus('Data byla automaticky uložena do localStorage.', 'success');
            }
        }
        
        // Funkce pro načtení dat z localStorage
        function nacistZLocalStorage() {
            const ulozenaData = localStorage.getItem(STORAGE_KEY);
            if (ulozenaData) {
                try {
                    tichaAktualizace = true; // Nastavit tichou aktualizaci
                    const data = JSON.parse(ulozenaData);
                    naplnitTabulky(data);
                    tichaAktualizace = false; // Vypnout tichou aktualizaci
                    zobrazitStatus('Data byla úspěšně načtena z localStorage.', 'success');
                } catch (e) {
                    console.error('Chyba při načítání dat:', e);
                    zobrazitStatus('Chyba při načítání dat z localStorage: ' + e.message, 'error');
                }
            }
        }
        
        // Funkce pro získání všech dat z tabulek
        function ziskatVsechnaData() {
            const zakazkyRadky = document.querySelectorAll('#zakazka-tbody tr');
            const hlavniRadky = document.querySelectorAll('#hlavni-tbody tr:not(#tlacitko-radek)');
            const zakazkaNadpis = document.getElementById('zakazka-nadpis').value;
            
            const zakazky = [];
            const hlavniData = [];
            
            zakazkyRadky.forEach(radek => {
                const textarea = radek.querySelector('textarea');
                zakazky.push(textarea.value);
            });
            
            hlavniRadky.forEach(radek => {
                const inputs = radek.querySelectorAll('input:not(.readonly)');
                const data = {
                    tavba: inputs[0].value,
                    vaha: inputs[1].value,
                    kusy: inputs[2].value,
                    misto: inputs[3].value,
                    poznamka: inputs[4].value
                };
                hlavniData.push(data);
            });
            
            return {
                zakazkaNadpis: zakazkaNadpis,
                zakazky: zakazky,
                hlavniData: hlavniData
            };
        }
        
        // Funkce pro naplnění tabulek daty
        function naplnitTabulky(data) {
            // Vyčištění tabulek
            document.getElementById('zakazka-tbody').innerHTML = '';
            document.getElementById('hlavni-tbody').innerHTML = '';
            
            // Reset počítadel
            pocetZakazek = 0;
            pocetHlavnichRadku = 0;
            
            // Naplnění nadpisu zakázky
            if (data.zakazkaNadpis) {
                document.getElementById('zakazka-nadpis').value = data.zakazkaNadpis;
            }
            
            // Naplnění zakázek
            data.zakazky.forEach(zakazka => {
                const tbody = document.getElementById('zakazka-tbody');
                const newRow = document.createElement('tr');
                newRow.id = 'zakazka-' + pocetZakazek;
                
                newRow.innerHTML = `
                    <td><textarea maxlength="15" rows="2" placeholder="Zakázka" class="zakazka-textarea" oninput="ulozitDoLocalStorage()">${zakazka || ''}</textarea></td>
                `;
                
                tbody.appendChild(newRow);
                pocetZakazek++;
            });
            
            // Naplnění hlavní tabulky
            data.hlavniData.forEach(radekData => {
                const tbody = document.getElementById('hlavni-tbody');
                const newRow = document.createElement('tr');
                newRow.id = 'hlavni-' + pocetHlavnichRadku;
                
                newRow.innerHTML = `
                    <td><input type="text" placeholder="Tavba" value="${radekData.tavba || ''}" oninput="ulozitDoLocalStorage()"></td>
                    <td><input type="number" placeholder="Váha" class="vaha" value="${radekData.vaha || ''}" oninput="prepocet(); 